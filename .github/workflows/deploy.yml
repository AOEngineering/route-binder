name: Deploy RouteBinder to Hetzner

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

concurrency:
  group: route-binder-deploy
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy via Appleboy SSH Action
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 5.161.103.30
          username: root
          key: ${{ secrets.SSH_KEY }}
          script_stop: true
          command_timeout: 30m
          script: |
            set -euo pipefail

            echo "Deploying RouteBinder, $(date -u)"

            APP_NAME="route-binder"
            REPO_DIR="/root/route-binder"
            APP_DIR="$REPO_DIR"
            PORT="3012"
            HOST="127.0.0.1"
            BRANCH="${GITHUB_REF_NAME:-master}"

            echo ""
            echo "0) Basic sanity"
            node -v || true
            npm -v || true
            free -h || true

            echo ""
            echo "0.1) Ensure pm2 exists"
            if ! command -v pm2 >/dev/null 2>&1; then
              npm install -g pm2
            fi

            echo ""
            echo "0.2) Ensure curl exists (real health checks)"
            if ! command -v curl >/dev/null 2>&1; then
              apt-get update
              apt-get install -y curl
            fi

            echo ""
            echo "1) Clone or update repo"
            if [ ! -d "$REPO_DIR/.git" ]; then
              rm -rf "$REPO_DIR"
              git clone https://github.com/AOEngineering/route-binder.git "$REPO_DIR"
            fi

            cd "$REPO_DIR"
            git fetch origin "$BRANCH"
            git reset --hard "origin/$BRANCH"
            git clean -fd

            echo ""
            echo "2) Install and build"
            cd "$APP_DIR"
            rm -rf .next
            export NODE_OPTIONS="--max-old-space-size=1024"

            if [ -f package-lock.json ]; then
              npm ci --no-audit --no-fund
            else
              npm install --no-audit --no-fund
            fi

            npm run build
            npm prune --omit=dev || true

            echo ""
            echo "3) Stop PM2 process and free the port"
            pm2 delete "$APP_NAME" >/dev/null 2>&1 || true

            if ss -lntp | grep -q ":$PORT"; then
              echo "Port $PORT is busy, freeing it"
              if command -v fuser >/dev/null 2>&1; then
                fuser -k "${PORT}/tcp" || true
              fi
              pkill -f "next start.*${PORT}" || true
              pkill -f "node_modules/next/dist/bin/next start.*${PORT}" || true
            fi

            echo ""
            echo "4) Start with PM2 pinned to $HOST:$PORT"
            export NODE_ENV="production"
            cd "$APP_DIR"

            # Use npm start so it matches your package.json, while forcing host and port
            pm2 start npm --name "$APP_NAME" --time -- start -- -p "$PORT" -H "$HOST"
            pm2 save || true

            echo ""
            echo "5) Health checks"
            pm2 status || true
            pm2 logs "$APP_NAME" --lines 60 --nostream || true

            ss -lntp | grep ":$PORT" || echo "Nothing listening on $PORT"

            # Retry a few times because Next can take a moment to become Ready
            for i in 1 2 3 4 5; do
              code="$(curl -s -o /dev/null -w "%{http_code}" "http://$HOST:$PORT" || true)"
              echo "Health attempt $i, HTTP $code"
              if [ "$code" = "200" ] || [ "$code" = "307" ] || [ "$code" = "308" ]; then
                exit 0
              fi
              sleep 2
            done

            echo "App not responding on http://$HOST:$PORT"
            exit 1

