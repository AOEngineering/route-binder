name: Deploy RouteBinder to Hetzner

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

concurrency:
  group: route-binder-deploy
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy via Appleboy SSH Action
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 5.161.103.30
          username: root
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -euo pipefail

            echo "Deploying RouteBinder, $(date -u)"

            APP_NAME="route-binder"
            REPO_DIR="/root/route-binder"
            APP_DIR="$REPO_DIR"
            BRANCH="main"
            PORT="3011"

            echo ""
            echo "1) Clone or update repo"
            if [ ! -d "$REPO_DIR/.git" ]; then
              rm -rf "$REPO_DIR"
              git clone git@github.com:AOEngineering/route-binder.git "$REPO_DIR"
            fi

            cd "$REPO_DIR"
            git fetch origin "$BRANCH"
            git reset --hard "origin/$BRANCH"
            git clean -fd

            echo ""
            echo "2) Install, build, prune"
            cd "$APP_DIR"
            rm -rf node_modules .next

            npm ci
            npm run build
            npm prune --omit=dev

            echo ""
            echo "3) Free port $PORT if something is squatting"
            if ss -lntp | grep -q ":$PORT"; then
              echo "Port $PORT is in use, killing listeners"
              PIDS="$(ss -lntp | awk -v p=":$PORT" '$0 ~ p {print $NF}' | sed -n 's/.*pid=\([0-9]\+\).*/\1/p' | sort -u)"
              for pid in $PIDS; do
                echo "Killing pid $pid"
                kill -9 "$pid" 2>/dev/null || true
              done
            else
              echo "Port $PORT appears free"
            fi

            echo ""
            echo "4) Start or reload PM2"
            export PORT="$PORT"
            if pm2 describe "$APP_NAME" >/dev/null 2>&1; then
              pm2 reload "$APP_NAME" --update-env
            else
              pm2 start npm --name "$APP_NAME" --cwd "$APP_DIR" -- start --time
            fi
            pm2 save

            echo ""
            echo "5) Reload Caddy (if present)"
            if [ -f /etc/caddy/Caddyfile ]; then
              caddy validate --config /etc/caddy/Caddyfile --adapter caddyfile
              caddy reload --config /etc/caddy/Caddyfile --adapter caddyfile
            else
              echo "Caddyfile not found at /etc/caddy/Caddyfile"
            fi

            echo ""
            echo "6) Status checks"
            echo "PM2:"
            pm2 list || true

            echo ""
            echo "Listening on $PORT:"
            ss -lntp | grep ":$PORT" || echo "Nothing listening on $PORT"

            echo ""
            echo "Local upstream check:"
            timeout 6 curl -s -o /dev/null -w "HTTP %{http_code}\n" "http://127.0.0.1:$PORT" || echo "App not responding"
