name: Deploy RouteBinder to Hetzner

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

concurrency:
  group: route-binder-deploy
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy via Appleboy SSH Action
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 5.161.103.30
          username: root
          key: ${{ secrets.SSH_KEY }}
          script_stop: true
          command_timeout: 30m
          script: |
            set -euo pipefail

            echo "Deploying RouteBinder, $(date -u)"

            REPO_DIR="/root/route-binder"
            APP_DIR="$REPO_DIR"
            PM2_NAME="route-binder"

            PORT="3012"
            HOST="127.0.0.1"

            # Branch from GitHub Actions trigger (works for both push + manual)
            REQUESTED_BRANCH="${GITHUB_REF_NAME:-}"

            if [ ! -d "$REPO_DIR/.git" ]; then
              echo "Cloning repo into $REPO_DIR"
              rm -rf "$REPO_DIR"
              git clone git@github.com:AOEngineering/RouteBinder.git "$REPO_DIR"
            fi

            cd "$APP_DIR"

            echo "Fetching"
            git fetch --all --prune

            # Pick a branch that exists locally or on origin
            BRANCH="$REQUESTED_BRANCH"

            if [ -z "$BRANCH" ]; then
              BRANCH="master"
            fi

            if ! git show-ref --verify --quiet "refs/remotes/origin/$BRANCH"; then
              echo "Requested branch '$BRANCH' not found on origin, falling back"
              if git show-ref --verify --quiet "refs/remotes/origin/master"; then
                BRANCH="master"
              elif git show-ref --verify --quiet "refs/remotes/origin/main"; then
                BRANCH="main"
              else
                echo "No origin/master or origin/main found, cannot deploy"
                git branch -a
                exit 1
              fi
            fi

            echo "Deploy branch: $BRANCH"
            git checkout -B "$BRANCH" "origin/$BRANCH"
            git reset --hard "origin/$BRANCH"
            git clean -fd

            echo "Install deps"
            if command -v npm >/dev/null 2>&1; then
              npm ci
            else
              echo "npm not found"
              exit 1
            fi

            echo "Build"
            npm run build

            echo "Start or restart with PM2 on ${HOST}:${PORT}"
            export PORT="$PORT"
            export HOSTNAME="$HOST"

            if pm2 list | grep -q "$PM2_NAME"; then
              pm2 delete "$PM2_NAME" || true
            fi

            pm2 start "node_modules/next/dist/bin/next" --name "$PM2_NAME" -- start -p "$PORT" -H "$HOST"
            pm2 save

            echo "Health check without curl"
            export HEALTH_URL="http://${HOST}:${PORT}"

            node <<'NODE'
            const http = require("http")

            const url = process.env.HEALTH_URL || "http://127.0.0.1:3012"
            let attempt = 0

            function ping() {
              attempt += 1
              const req = http.get(url, res => {
                const code = res.statusCode || 0
                res.resume()

                if (code >= 200 && code < 500) {
                  console.log("Health OK", code)
                  process.exit(0)
                }

                retry()
              })

              req.on("error", retry)
            }

            function retry() {
              if (attempt >= 12) {
                console.error("App not responding on", url)
                process.exit(1)
              }
              setTimeout(ping, 1000)
            }

            ping()
            NODE

            echo "Deploy complete"
