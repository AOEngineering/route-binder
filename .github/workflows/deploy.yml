name: Deploy RouteBinder to Hetzner

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

concurrency:
  group: route-binder-deploy
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install deps (runner)
        run: npm ci

      - name: Build (runner)
        run: npm run build

      - name: Prune to production deps (runner)
        run: npm prune --omit=dev

      - name: Create release tarball (runner)
        run: |
          set -euo pipefail
          RELEASE="routebinder_${GITHUB_SHA}.tgz"
          tar -czf "$RELEASE" \
            .next \
            public \
            package.json \
            package-lock.json \
            next.config.mjs \
            node_modules
          ls -lh "$RELEASE"

      - name: Upload release to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: 5.161.103.30
          username: root
          key: ${{ secrets.SSH_KEY }}
          source: routebinder_${{ github.sha }}.tgz
          target: /root/route-binder/.incoming

      - name: Activate release on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 5.161.103.30
          username: root
          key: ${{ secrets.SSH_KEY }}
          script_stop: true
          command_timeout: 30m
          script: |
            set -euo pipefail

            PM2_NAME="route-binder"
            PORT="3012"
            HOST="127.0.0.1"

            DEPLOY_ROOT="/root/route-binder"
            INCOMING="${DEPLOY_ROOT}/.incoming"
            RELEASES="${DEPLOY_ROOT}/.releases"
            CURRENT="${DEPLOY_ROOT}/current"

            RELEASE_FILE="routebinder_${GITHUB_SHA}.tgz"
            SRC_TGZ="${INCOMING}/${RELEASE_FILE}"

            mkdir -p "$INCOMING" "$RELEASES"

            if [ ! -f "$SRC_TGZ" ]; then
              echo "Missing uploaded release: $SRC_TGZ"
              ls -la "$INCOMING" || true
              exit 1
            fi

            TS="$(date -u +%Y%m%d_%H%M%S)"
            NEW_RELEASE="${RELEASES}/${TS}_${GITHUB_SHA}"
            mkdir -p "$NEW_RELEASE"

            echo "Stopping PM2 app if present"
            pm2 stop "$PM2_NAME" >/dev/null 2>&1 || true
            pm2 delete "$PM2_NAME" >/dev/null 2>&1 || true

            echo "Free port ${PORT}"
            for i in $(seq 1 10); do
              if fuser -n tcp "$PORT" >/dev/null 2>&1; then
                echo "Port in use, killing, attempt ${i}"
                fuser -n tcp -k "$PORT" >/dev/null 2>&1 || true
                sleep 1
              else
                break
              fi
            done

            if fuser -n tcp "$PORT" >/dev/null 2>&1; then
              echo "Port still busy"
              ss -ltnp 2>/dev/null | grep ":$PORT" || true
              exit 1
            fi

            echo "Extract release"
            tar -xzf "$SRC_TGZ" -C "$NEW_RELEASE"
            rm -f "$SRC_TGZ"

            echo "Activate symlink"
            ln -sfn "$NEW_RELEASE" "$CURRENT"

            echo "Start with PM2 on ${HOST}:${PORT}"
            cd "$CURRENT"
            export PORT="$PORT"
            export HOSTNAME="$HOST"

            pm2 start "node_modules/next/dist/bin/next" --name "$PM2_NAME" --time -- start -p "$PORT" -H "$HOST"
            pm2 save >/dev/null 2>&1 || true

            echo "Health check"
            export HEALTH_URL="http://${HOST}:${PORT}"
            node -e "const http=require('http'); const url=process.env.HEALTH_URL; let a=0; const m=25; function ping(){ a++; const req=http.get(url,res=>{ const c=res.statusCode||0; res.resume(); if(c>=200&&c<500){ console.log('Health OK',c); process.exit(0);} retry();}); req.on('error',retry);} function retry(){ if(a>=m){ console.error('App not responding on',url); process.exit(1);} setTimeout(ping,1000);} ping();"

            echo "Deploy complete"
