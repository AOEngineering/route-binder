name: Deploy RouteBinder to Hetzner

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy RouteBinder via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 5.161.103.30
          username: root
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e

            echo "→ Deploying RouteBinder, $(date -u)"

            cd /root/route-binder
            git fetch origin master || true
            git fetch origin main || true

            # prefer the branch that triggered the workflow
            BRANCH="${GITHUB_REF_NAME:-master}"
            git checkout "$BRANCH" 2>/dev/null || git checkout -b "$BRANCH" "origin/$BRANCH" 2>/dev/null || true

            # fall back if needed
            if git rev-parse --verify "origin/$BRANCH" >/dev/null 2>&1; then
              git reset --hard "origin/$BRANCH"
            elif git rev-parse --verify "origin/master" >/dev/null 2>&1; then
              BRANCH="master"
              git reset --hard "origin/master"
            else
              BRANCH="main"
              git reset --hard "origin/main"
            fi

            git clean -fd

            echo "→ Install deps"
            export NEXT_TELEMETRY_DISABLED=1
            export NODE_OPTIONS="--max-old-space-size=512"

            if [ -f package-lock.json ]; then
              npm ci --no-audit --no-fund
            else
              npm install --no-audit --no-fund
            fi

            echo "→ Build"
            rm -rf .next
            npm run build

            echo "→ Restart PM2"
            pm2 delete route-binder || true
            fuser -n tcp -k 3012 || true
            sleep 1

            PORT=3012 HOSTNAME=127.0.0.1 pm2 start npm --name route-binder -- run start -- -p 3012 -H 127.0.0.1
            pm2 save

            echo "→ Done"
